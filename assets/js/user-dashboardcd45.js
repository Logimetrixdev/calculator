rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.directive("rhAboutMe",function(rhHistoryService,loginService){return{restrict:"C",controller:"AboutMeCtrl",link:{post:function(scope,elem,attrs){scope.calculateCompletion();if(window.location.href.indexOf("msg=")!==-1){var msg=window.location.href.split("msg=")[1].split("&")[0];switch(msg){case "updatedEmail":loginService.displaySaveBar("change-email");break;case "error":alert(Globalize.localize("unknown-err-msg"));break;default:break}}$(window).bind("popstate",function(event){event.preventDefault();
var state=event.originalEvent.state;if(state)scope.$apply(function(){scope.showPanel=state.showPanel})});rhHistoryService.replaceState(scope.getStateObject(),null)}}}});
rh.ng.controller("AboutMeCtrl",function($scope,$timeout,rhHttpRequestService,rhEnvironmentService,rhHistoryService,loginService){$scope.saveProfile=function(){$scope.personalInfoForm.submitting=true;rhHttpRequestService.post({url:"/api/user-dashboard?callback=true&operation=saveUserProfile",data:$scope.profileInputs,success:function(){loginService.displaySaveBar("save-profile");$scope.personalInfoForm.submitting=false;$scope.calculateCompletion()},error:function(){alert(Globalize.localize("unknown-err-msg"));
$scope.personalInfoForm.submitting=false}})};$scope.drawChart=function(complete,incomplete,color){$(function(){var profileChart=new Highcharts.Chart({chart:{type:"pie",renderTo:"profile-chart"},title:{text:""},plotOptions:{pie:{shadow:false}},credits:{enabled:false},tooltip:{enabled:false},series:[{name:"Personal Information",data:[{name:"Complete",y:complete,color:color},{name:"Incomplete",y:incomplete,color:"white"}],size:"50%",innerSize:"37%",dataLabels:{enabled:false},borderWidth:0}]})})};$scope.calculateCompletion=
function(){var progress=0;$.each($scope.profileInputs,function(key,val){if(val!==null&&val!=="")progress++});var complete=progress/5*100;if(complete!==$scope.completedFields){var roundedComplete=0;var color="white";var isLOAP=isRatehubLoap();switch(true){case complete>87.5:roundedComplete=100;color=isLOAP?"#4ab879":"#669F68";break;case complete>62.5:roundedComplete=75;color=isLOAP?"#ffcc50":"#E4D089";break;case complete>37.5:roundedComplete=50;color=isLOAP?"#ff6e37":"#EBA162";break;case complete>
12.5:roundedComplete=25;color=isLOAP?"#ff8f9a":"#DD5531";break;default:break}$scope.drawChart(roundedComplete,100-roundedComplete,color);$scope.profilePercentage=roundedComplete.toString()+"%";if(roundedComplete<100)$scope.profileCompleteTitle=Globalize.localize("profile-almost-complete-title");else $scope.profileCompleteTitle=Globalize.localize("profile-complete-title");$scope.completedFields=complete}};$scope.disableAccount=function(){$scope.disableAccountForm.submitting=true;rhHttpRequestService.post({url:"/api/account/disable",
data:$scope.usernameInputs,success:function(){window.open(ratehub.serverUri+"/logout","_self")},error:function(response){$scope.error.disable=Globalize.localize(response.errors[0].code)}})};$scope.validateDisableAccount=function(){$scope.allowDisable=$scope.disableConfirmation==="DISABLE"||$scope.disableConfirmation==="D\u00c9SACTIVER"};$scope.changePassword=function(){$scope.changePasswordForm.submitting=true;rhHttpRequestService.post({url:"/api/password/change",data:$scope.passwordInputs,success:function(){$scope.error.password=
null;loginService.displaySaveBar("change-password");$scope.changePasswordForm.submitting=false},error:function(response){$scope.error.password=Globalize.localize(response.errors[0].code);$scope.changePasswordForm.submitting=false}})};$scope.changeEmail=function(){$scope.changeEmailForm.submitting=true;rhHttpRequestService.post({url:"/email/change",data:$scope.emailInputs,success:function(){$scope.error.email=null;$scope.changeEmailForm.submitting=false;loginService.displaySaveBar("change-email")},
error:function(response){$scope.error.email=Globalize.localize(response.errors[0].code);$scope.changeEmailForm.submitting=false}})};$scope.showManageAccount=function(){$scope.showPanel="manage-account";rhHistoryService.pushState($scope.getStateObject(),null,window.location)};$scope.showPersonalInformation=function(){$scope.showPanel="personal-information";rhHistoryService.pushState($scope.getStateObject(),null,window.location)};$scope.getStateObject=function(){return{showPanel:$scope.showPanel}};
$scope.profileInputs={location:ratehub.user.location};$scope.emailInputs={};$scope.passwordInputs={};$scope.usernameInputs={};$scope.error={};$scope.allowDisable=false;$scope.disableConfirmation="";$scope.profilePercentage=null;$scope.profileCompleteTitle=null;$scope.completedFields=null;$scope.showPanel="personal-information"});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.directive("rhCreditScoreForm",function($compile,rhHttpRequestService,rhHistoryService){return{restrict:"A",controller:"CreditScoreFormCtrl",link:{post:function(scope,elem,attrs){scope.creditScoreBrackets=ratehub.creditScoreBrackets;if(attrs.step)scope.setStep(parseInt(attrs.step));if(scope.step>0)scope.isLoading=true;if(scope.step==1)scope.updateReasonForInquiry();if(scope.step==3)scope.getIdentityQuestions();$(window).bind("popstate",function(event){event.preventDefault();var state=event.originalEvent.state;
if(state)scope.$apply(function(){scope.setStep(state.step)})});rhHistoryService.replaceState(scope.getStateObject(),null)}}}});
rh.ng.controller("CreditScoreFormCtrl",function($scope,$compile,$timeout,$sce,rhHttpRequestService,rhHistoryService,rhEnvironmentService,loginService){$scope.getStateObject=function(){return{step:$scope.step}};$scope.fetchOffers=function(){var ownsHome=typeof $scope.questions.homeWorth!=="undefined";$scope.isLoading=true;rhHttpRequestService.post({url:"/api/user-dashboard?callback=true&operation=getOffer",data:{score:$scope.scoreBucket()},success:function(data){if(!data.length){$scope.hasOffers=false;
$scope.isLoading=false;rh.Dialog.close()}else{$scope.hasOffers=true;var container=$(".rh-credit-score__offers");container.html(data);$compile(container)($scope)}rhHttpRequestService.post({url:"/api/user-dashboard?callback=true&operation=getCreditReport",success:function(data){if(data.status==="success")$scope.report=data.data;$scope.isLoading=false;rh.Dialog.close()},error:function(data){$scope.isLoading=false;rh.Dialog.close()}})}})};$scope.isIdentityLocked=function(){return $scope.invalidAttempts>=
2};$scope.scoreBucket=function(){switch(true){case $scope.creditScore>$scope.creditScoreBrackets.excellent:return 5;case $scope.creditScore>$scope.creditScoreBrackets.veryGood:return 4;case $scope.creditScore>$scope.creditScoreBrackets.good:return 3;case $scope.creditScore>$scope.creditScoreBrackets.fair:return 2;default:return 1}};$scope.hasCreditScore=function(){return $scope.creditScore>0};$scope.displayCardFinderCTA=function(){return ratehub&&ratehub.creditScoreReferrer};$scope.returnToCardFinder=
function(){var serverUri=ratehub&&ratehub.serverUri?ratehub.serverUri:"https://www.ratehub.ca";window.open(serverUri+ratehub.creditScoreReferrer,"_self")};$scope.setStep=function(step){switch(step){case 0:$scope.showPage="credit-score-gauge";$scope.disableLoading();break;case 1:$scope.showPage="credit-score-forms";$scope.disableLoading();break;case 2:$scope.showPage="validate-sin-question";$scope.disableLoading();break;case 3:$scope.showPage="validate-identity-questions";break;case 4:$scope.showPage=
"credit-score-questions";$scope.disableLoading();break;case 5:$scope.showPage="credit-score-results";$scope.scrollIntoView();break;default:return}$scope.step=step};$scope.show=function(page){var pushState=false;$scope.isLoading=false;switch(page){case "credit-score-forms":$scope.step=1;pushState=true;break;case "validate-sin-question":$scope.scrollIntoView();setTimeout(function(){$scope.step=2;pushState=true;$timeout(function(){var sinInput=$("#sinOne");if(!sinInput.val())sinInput.focus()})});break;
case "validate-identity-questions":$scope.step=3;pushState=true;break;case "credit-score-questions":$scope.step=4;pushState=true;rh.Dialog.close();break;case "credit-score-results":$scope.step=5;pushState=true;rh.Dialog.close();break;case "credit-score-gauge":break;case "email-validation-sent":$scope.scrollIntoView("#email_sent");break;default:return}$scope.showPage=page;if(pushState){if($scope.step===5)var url="/dashboard/credit-score/report";else var url="/dashboard/credit-score/step-"+$scope.step;
if(window.location.pathname!=url){rhHistoryService.pushState($scope.getStateObject(),null,url);ga("set","page",url);ga("send","pageview")}}};$scope.stepToPage=function(step){switch(step){case 1:return"credit-score-forms";case 2:return"validate-sin-question";case 3:return"validate-identity-questions";case 4:return"credit-score-questions";case 5:return"credit-score-results";default:return null}};$scope.maybeShowMortgageQuestions=function(){return $scope.reasonForInquiryOptions.debt||$scope.reasonForInquiryOptions.loan||
$scope.reasonForInquiryOptions.monitor};$scope.maybeShowCreditCardQuestions=function(){return $scope.reasonForInquiryOptions.rental};$scope.showModal=function(content,closeCallback){$scope.modal=content;var popupOptions=$scope.inlinePopupOptions;if(closeCallback){var defaultCloseCallback=popupOptions.onClosed;popupOptions=$.extend({},popupOptions,{onClosed:function(){defaultCloseCallback();closeCallback()}})}rh.Dialog.openAsPopup("#warning_or_error",popupOptions)};$scope.closeModal=function(){rh.Dialog.close()};
$scope.showNoQuestionsWarning=function(){$scope.showModal({title:$sce.trustAsHtml("We were unable to verify<br>your information"),message:$sce.trustAsHtml("<p>You may have made a mistake entering your information or you may not have a credit file with Equifax.</p><p>Please try again</p>"),button:"Try again"})};$scope.showInvalidIdentityWarning=function(options){var content=null;var closeCallback=null;if($scope.invalidAttempts===1)content={title:$sce.trustAsHtml("We were unable to verify<br>your identity"),
message:$sce.trustAsHtml("<p>You may have answered the identification questions incorrectly or you may not have a credit file with Equifax.</p><p>Please try again</p>"),button:"Try again"};else if($scope.invalidAttempts>=2){content={title:$sce.trustAsHtml("We were unable to verify<br>your identity"),message:$sce.trustAsHtml("<p>At this time we cannot provide your free credit score.</p>"),button:"OK"};closeCallback=function(){document.location.reload()}}$scope.showModal(content,closeCallback)};$scope.showErrorWarning=
function(options){$scope.showModal({title:$sce.trustAsHtml("An error occurred while<br>submitting your information."),message:$sce.trustAsHtml("<p>This is usually a result of the Equifax database being temporarily unavailable.</p><p>Please try again later.</p>"),button:"OK"})};$scope.showNoHitWarning=function(options){$scope.showModal({title:$sce.trustAsHtml("We were unable to locate your<br>credit report."),message:$sce.trustAsHtml("<p>You may have entered incorrect personal information, or may not have a credit report with Equifax.<p><p>Please verify your personal information is correct.</p>"),
button:"OK"})};$scope.scrollIntoView=function(selector,callback){if(!selector)selector=".rh-credit-score";setTimeout(function(){$(selector)[0].scrollIntoView(true)})};$scope.disableLoading=function(when){when=when||1E3;$timeout(function(){$scope.isLoading=false},when)};$scope.isDataFormValid=function(){return $scope.reasonForInquiryOptions.mortgage||$scope.reasonForInquiryOptions.debt||$scope.reasonForInquiryOptions.rental||$scope.reasonForInquiryOptions.card||$scope.reasonForInquiryOptions.loan||
$scope.reasonForInquiryOptions.monitor};$scope.isQuestionsFormValid=function(){var valid=true;if($scope.maybeShowMortgageQuestions())valid&=$scope.validateMortgageQuestions();if($scope.maybeShowCreditCardQuestions())valid&=$scope.validateCreditCardQuestions();return valid};$scope.validateMortgageQuestions=function(){var valid=false;if($scope.questions.ownHome=="Yes")valid=typeof $scope.questions.homeWorth!=="undefined"&&typeof $scope.questions.mortgageSize!=="undefined"&&typeof $scope.questions.mortgageRenew===
"string";else if($scope.questions.ownHome=="No")valid=true;return valid};$scope.validateCreditCardQuestions=function(){var valid=true;if($scope.questions.howManyCards)switch($scope.questions.howManyCards){case "1":valid=typeof $scope.questions.cardOne!=="undefined";break;case "2":valid=typeof $scope.questions.cardOne!=="undefined"&&typeof $scope.questions.cardTwo!=="undefined";break;case "3 or more":valid=typeof $scope.questions.cardOne!=="undefined"&&typeof $scope.questions.cardTwo!=="undefined"&&
typeof $scope.questions.cardThree!=="undefined";break;case "None":valid=true;break;default:valid=false}else valid=false;return valid};$scope.submitDataForm=function(){if($scope.userInfo.createUser==="true"){var apiErrorCallback=function(response){var message=Globalize.localize(response.errors[0].code);if(!message||message==="undefined")Globalize.localize("unknown-err-msg");alert(message);$scope.submitting=false};var registerUserErrorCallback=function(response){$scope.submitting=false;if(response.errors[0].code===
"disabled-user"){var params={email:$scope.userInfo.email,first_name:$scope.userInfo.first_name,last_name:$scope.userInfo.last_name};rh.Dialog.show(appendQueryParams("/re-enable-account",params),{popupClass:"rh-re-enable-popup"})}else $scope.registerUserErrMsg=Globalize.localize(response.errors[0].code)};var registerUserSuccess=function(response){$scope.userInfo.api_token=response.data.token;$scope.validateUser({token:response.data.token},validateUserSuccess,apiErrorCallback)};var validateUserSuccess=
function(response){$scope.loginUser({email:$scope.userInfo.email,password:$scope.userInfo.password,_token:ratehub.csrf},loginUserSuccess,apiErrorCallback)};var loginUserSuccess=function(response){$scope.userInfo.api_token=response.data.token;$scope.saveUserProfile({success:saveUserProfileSuccess,error:apiErrorCallback})};var saveUserProfileSuccess=function(response){analyticsEvent({"event":"free-credit-score-profile-saved","eventCategory":"free-credit-score","eventAction":"register-pre-verify"});
$scope.submitting=false;window.location="/dashboard/credit-score/step-2"};$scope.registerUser($scope.userInfo,registerUserSuccess,registerUserErrorCallback)}else{$scope.userInfo.api_token=ratehub.user.api_token;$scope.userInfo.email=$scope.userInfo.existingEmail;$scope.saveUserProfile({success:function(data){$scope.show("validate-sin-question");$scope.submitting=false},error:function(data){alert(Globalize.localize("unknown-err-msg"));$scope.submitting=false}})}};$scope.submitMortgageQuestionsForm=
function(){$scope.isLoading=true;$scope.saveMortgageAnswers({success:function(){$scope.show("credit-score-results");$scope.submitting=false},error:function(){alert(Globalize.localize("unknown-err-msg"));$scope.submitting=false}})};$scope.registerUser=function(data,onSuccess,onError){$scope.submitting=true;var options={url:"/api/register",data:data,headers:{"Content-Type":"application/json"}};if(onSuccess)options.success=function(successData){if(data.email)addEmailToHeap(data.email);onSuccess(successData)};
if(onError)options.error=onError;rhHttpRequestService.post(options)};$scope.validateUser=function(data,onSuccess,onError){var options={url:"/api/register/validate",data:data,headers:{"Content-Type":"application/json"}};if(onSuccess)options.success=onSuccess;if(onError)options.error=onError;rhHttpRequestService.post(options)};$scope.loginUser=function(data,onSuccess,onError){var options={url:"/authenticate",data:data,headers:{"Content-Type":"application/json"}};if(onSuccess)options.success=onSuccess;
if(onError)options.error=onError;rhHttpRequestService.post(options)};$scope.saveUserProfile=function(callback){var userInfo=$.extend({"reasonForInquiry":$scope.reasonForInquiry,"step":$scope.step+1,"operation":"saveUserProfile"},$scope.userInfo);$scope.submitting=true;var options={url:"/api/user-dashboard/saveUserProfile",data:userInfo};if(callback.success)options.success=callback.success;if(callback.error)options.error=callback.error;rhHttpRequestService.post(options)};$scope.saveMortgageAnswers=
function(){var questions=$.extend({"step":$scope.step+1},$scope.questions);$scope.submitting=true;var options={url:"/api/user-dashboard?callback=true&operation=saveMortgageAnswers",data:questions};if(callback.success)options.success=callback.success;if(callback.error)options.error=callback.error;rhHttpRequestService.post(options)};$scope.getIdentityQuestions=function(){if($scope.isIdentityLocked())return;rh.Dialog.openAsPopup("#credit_comms",$scope.inlinePopupOptions);$scope.submitting=true;var sin=
$scope.sin;$scope.sin=null;$scope.$broadcast("resetSin");rhHttpRequestService.post({url:"/api/user-dashboard?callback=true&operation=getIdentityQuestions",data:{sin:sin,api_token:$scope.userInfo.api_token},success:function(resp){$scope.show("validate-identity-questions");$scope.submitting=false;$scope.disableLoading(1);$scope.identityQuestions=resp.data.questions;rh.Dialog.close()},error:function(resp){$scope.submitting=false;if(resp.status==="fail"){$scope.invalidAttempts=resp.data.failed_attempts||
null;$scope.showNoQuestionsWarning()}else $scope.showErrorWarning();if($scope.isIdentityLocked())$scope.lockForms=true;else $scope.show("credit-score-forms")}})};$scope.submitIdentityQuestionsForm=function(){rh.Dialog.openAsPopup("#credit_comms",$scope.inlinePopupOptions);$scope.submitting=true;rhHttpRequestService.post({url:"/api/user-dashboard?callback=true&operation=sendIdentityAnswers",data:$scope.identityAnswers,success:function(resp){$scope.creditScore=resp.data.credit_score;$scope.submitting=
false;analyticsEvent({"event":"free-credit-score-post-verify","eventCategory":"free-credit-score","eventAction":"verification-complete"});$scope.show($scope.stepToPage(resp.data.step))},error:function(resp){$scope.submitting=false;resp.data=resp.data||{};if(resp.status=="fail"){$scope.invalidAttempts=resp.data.failed_attempts||null;if(resp.data.questions){for(var answer in $scope.identityAnswers)$scope.identityAnswers[answer]=null;$scope.identityQuestions=resp.data.questions}if(resp.message==="No hit"){$scope.showNoHitWarning();
$scope.show("credit-score-forms")}else if($scope.invalidAttempts)$scope.showInvalidIdentityWarning();else $scope.showErrorWarning()}else{$scope.showErrorWarning();$scope.show("credit-score-forms")}if($scope.isIdentityLocked())$scope.lockForms=true}})};$scope.$watch("[step, creditScore, invalidAttempts]",function(newValue,oldValue){if($scope.step===5){$scope.fetchOffers();ga("set","campaignMedium","referral");ga("set","campaignSource","Free Credit Score")}if($scope.invalidAttempts>1)$scope.show("credit-score-forms")},
true);$scope.updateReasonForInquiry=function(){if($scope.reasonForInquiry){$scope.reasonForInquiryOptions[$scope.reasonForInquiry]=false;$scope.reasonForInquiry=null}$.each($scope.reasonForInquiryOptions,function(key,val){if(val)$scope.reasonForInquiry=key})};$scope.activeMenu="score";$scope.userInfo={};$scope.identityQuestions=null;$scope.identityAnswers={};$scope.questions={};$scope.creditScore=null;$scope.step=null;$scope.reasonForInquiryOptions={};$scope.inlinePopupOptions={width:"590px",height:"650px",
inline:true,isMobile:rhEnvironmentService.isMobileView(),onClosed:function(){$scope.scrollIntoView()}};$scope.showPage="credit-score-gauge"});
rh.ng.directive("creditScoreReport",function($filter,$sce){return{restrict:"A",controller:function($scope){$scope.customValues={summary:[{name:"Revolving credit utilization",key:"creditUtilization"},{name:"Number of late payments",key:"missedPayments"},{name:"Age of credit history",key:"ageOfCreditHistory"},{name:"Total # of open accounts",key:"numberOfOpenAccounts"},{name:"Collections",key:"collections"},{name:"Credit inquiries",key:"creditInquiries"}],trades:[{name:"Revolving",key:"R",accounts:[],
imageSrc:"/assets/images/user-dashboard/Revolving-300.png"},{name:"Installments",key:"I",accounts:[],imageSrc:"/assets/images/user-dashboard/Installments-300.png"},{name:"Mortgages",key:"M",accounts:[],imageSrc:"/assets/images/user-dashboard/Mortgages-300.png"},{name:"Other loans",key:"O",accounts:[],imageSrc:"/assets/images/user-dashboard/OtherLoans-300.png"}],accountFields:[{name:"Phone number",key:"phoneNumber",format:{type:"phone-number",recordKey:["CreditorId","Telephone","ParsedTelephone"]}},
{name:"Account number",key:"accountNumber",format:{type:"custom",recordKey:["AccountNumber"],parse:function(value){var accountNumber=$scope.removeLeadingZeroes(value).toString();return"XXX . . . "+accountNumber.substring(accountNumber.length-4)}}},{name:"Association to account",key:"associationToAccount",format:{recordKey:["Association","description"]}},{name:"Type of account",key:"typeOfAccount",format:{recordKey:["PortfolioType","description"]}},{name:"Date opened",key:"dateOpened",format:{recordKey:["DateOpened"]}},
{name:"Status",key:"accountStatus",format:{recordKey:["Status"]}},{name:"Months reviewed",key:"monthsReviewed",format:{recordKey:["MonthsReviewed"],removeLeadingZeroes:true}},{name:"Payment history",key:"paymentHistory",format:{type:"custom",recordKey:["HistoryDerogatoryCounters"],parse:function(value){var payHistory=[];var payTerm=["30","60","90"];for(var i=0;i<payTerm.length;i++){var payDesc="";var latePayments=value["Count"+payTerm[i]+"DayPastDue"]||0;latePayments=$scope.removeLeadingZeroes(latePayments);
if(latePayments>0)payDesc=latePayments+" payment"+(latePayments>1?"s ":" ")+payTerm[i]+" days late";else payDesc="No payment "+payTerm[i]+" days late";$scope.customValues.summary[$scope.getIndex("missedPayments")].value+=latePayments;payHistory.push(payDesc)}return payHistory.join("<br />")}}},{name:"Comments",key:"comments",format:{type:"custom",recordKey:["Narratives"],parse:function(value){var narratives=[];for(var i=0;i<value.length;i++)narratives.push(value[i].description);return narratives.join("<br />")}}},
{name:"High credit/credit limit",key:"highCredit",format:{type:"currency",recordKey:["HighCreditAmount"],removeLeadingZeroes:true}},{name:"Payment amount",key:"paymentAmount",format:{type:"currency",recordKey:["PaymentTermAmount"],removeLeadingZeroes:true}},{name:"Balance",key:"balance",format:{type:"currency",recordKey:["BalanceAmount"],removeLeadingZeroes:true}},{name:"Past due",key:"pastDue",format:{type:"currency",recordKey:["PastDueAmount"],removeLeadingZeroes:true}},{name:"Date of last activity",
key:"dateOfLastActivity",format:{recordKey:["DateLastActivityOrPayment"]}},{name:"Date reported",key:"dateReported",format:{recordKey:["DateReported"]}}],collections:[],collectionFields:[{name:"Collector agent",key:"collectorAgent",format:{recordKey:["AgencyId","Name"]}},{name:"Creditor",key:"creditor",format:{type:"custom",recordKey:["CollectionCreditor","AccountNumberAndOrName"],defaultValue:"UNKNOWN",parse:function(value){return value}}},{name:"Status",key:"collectionStatus",format:{type:"custom",
recordKey:["DatePaid"],defaultValue:"Unpaid",parse:function(value){return"Paid"}}},{name:"Original balance",key:"originalBalance",format:{type:"currency",recordKey:["OriginalAmount"],removeLeadingZeroes:true}},{name:"Current balance",key:"currentBalance",format:{type:"currency",recordKey:["BalanceAmount"],removeLeadingZeroes:true}},{name:"Date of last payment",key:"dateOfLastPayment",format:{recordKey:["DateOfLastPayment"],defaultValue:"N/A"}},{name:"Date paid",key:"datePaid",format:{recordKey:["DatePaid"]}}],
inquiries:[]};$scope.unpack=function(obj,fields){var parsedFields=[];for(var i=0;i<fields.length;i++){var self=fields[i];var field={name:self.name,value:null};var args=self.format.recordKey.slice();args.unshift(obj);if(checkNested.apply(null,args)){var deepProperty=self.format.recordKey.join(".");var objProp=eval("obj."+deepProperty);if(self.format.removeLeadingZeroes)objProp=$scope.removeLeadingZeroes(objProp);switch(self.format.type){case "phone-number":field.value="("+objProp.AreaCode+") "+objProp.Number;
break;case "currency":field.value=$scope.$eval($filter("json")(objProp)+"| format:'c2'");break;case "custom":field.value=self.format.parse(objProp);break;default:field.value=objProp}}else field.value=self.format.defaultValue;if(field.value){field.value=$sce.trustAsHtml(field.value.toString());parsedFields.push(field)}}return parsedFields};$scope.getIndex=function(key){for(var i=0;i<$scope.customValues.summary.length;i++)if(key===$scope.customValues.summary[i].key)return i;for(var i=0;i<$scope.customValues.trades.length;i++)if(key===
$scope.customValues.trades[i].key)return i;for(var i=0;i<$scope.customValues.accountFields.length;i++)if(key===$scope.customValues.accountFields[i].key)return i;for(var i=0;i<$scope.customValues.collectionFields.length;i++)if(key===$scope.customValues.collectionFields[i].key)return i;return-1};$scope.removeLeadingZeroes=function(value){return parseInt(value)};$scope.getReportDateString=function(){if($scope.report&&$scope.report.header&&$scope.report.header.CreditFile&&$scope.report.header.CreditFile.DateOfRequest){var date=
new Date($scope.report.header.CreditFile.DateOfRequest);date.setDate(date.getDate()+1);return Globalize.format(date,"MMMM dd, yyyy")}return null}}}});
rh.ng.directive("creditScoreReportSummary",function(){return{restrict:"A",controller:function($scope){$scope.$watch("report",function(newValue,oldValue){if(newValue!==oldValue){$scope.customValues.summary[$scope.getIndex("creditUtilization")].value="0%";$scope.customValues.summary[$scope.getIndex("missedPayments")].value=0;$scope.customValues.summary[$scope.getIndex("ageOfCreditHistory")].value="0 yrs";$scope.customValues.summary[$scope.getIndex("numberOfOpenAccounts")].value=0;$scope.customValues.summary[$scope.getIndex("collections")].value=
0;$scope.customValues.summary[$scope.getIndex("creditInquiries")].value=0;$scope.customValues.totalBalance=0;$scope.customValues.totalCreditLimit=0;var oldestAccount=new Date;$scope.customValues.summary[$scope.getIndex("creditInquiries")].value+=$scope.report.inquiries?$scope.report.inquiries.length:0;for(var i=0;i<$scope.customValues.trades.length;i++){var tradeKey=$scope.customValues.trades[i].key;if(!$scope.report.trades[tradeKey])continue;for(var j=0;j<$scope.report.trades[tradeKey].length;j++){var tradeAccount=
$scope.report.trades[tradeKey][j];if(checkNested(tradeAccount,"DateOpened")){var accountAge=new Date(tradeAccount.DateOpened);if(accountAge.getTime()<oldestAccount.getTime()){var age=(new Date).getFullYear()-accountAge.getFullYear();$scope.customValues.summary[$scope.getIndex("ageOfCreditHistory")].value=age+" yr"+(age>1?"s":"");oldestAccount=accountAge}}if(tradeKey==="R"&&checkNested(tradeAccount,"HighCreditAmount")&&checkNested(tradeAccount,"BalanceAmount")){$scope.customValues.totalBalance+=parseInt($scope.removeLeadingZeroes(tradeAccount.BalanceAmount));
$scope.customValues.totalCreditLimit+=parseInt($scope.removeLeadingZeroes(tradeAccount.HighCreditAmount))}}$scope.customValues.summary[$scope.getIndex("numberOfOpenAccounts")].value+=$scope.report.trades[tradeKey].length}var utilization=0;if($scope.customValues.totalCreditLimit)utilization=$scope.customValues.totalBalance/$scope.customValues.totalCreditLimit;$scope.customValues.summary[$scope.getIndex("creditUtilization")].value=Globalize.format(utilization,"p0").replace(" ","")}},true)},template:"<table>"+
"<thead>"+"<tr>"+'<th ng-repeat="item in customValues.summary">'+'<div ng-bind="item.name" class="summary-item"></div>'+"</th>"+"</tr>"+"</thead>"+"<tbody>"+"<tr>"+'<td ng-repeat="item in customValues.summary">'+'<div ng-bind="item.value" class="summary-item"></div>'+"</td>"+"</tr>"+"</tbody>"+"</table>"}});
rh.ng.directive("creditScoreReportMain",function($timeout){return{restrict:"A",controller:function($scope){$scope.$watch("report",function(newValue,oldValue){if(newValue!==oldValue)for(var i=0;i<$scope.customValues.trades.length;i++){var tradeKey=$scope.customValues.trades[i].key;var balance=0;if($scope.report.trades[tradeKey]){for(var j=0;j<$scope.report.trades[tradeKey].length;j++)balance+=$scope.removeLeadingZeroes($scope.report.trades[tradeKey][j].BalanceAmount);$scope.customValues.trades[i].balance=
balance}else $scope.customValues.trades[i].balance="N/A"}},true);$scope.setActiveReport=function(reportKey){$scope.activeReport=reportKey;$scope.activeAccount=null};$scope.prevReport=function(){$timeout(function(){var current=$scope.getIndex($scope.activeReport);if(current===0)$scope.activeReport=$scope.customValues.trades[$scope.customValues.trades.length-1].key;else $scope.activeReport=$scope.customValues.trades[current-1].key})};$scope.nextReport=function(){$timeout(function(){var current=$scope.getIndex($scope.activeReport);
if(current===$scope.customValues.trades.length-1)$scope.activeReport=$scope.customValues.trades[0].key;else $scope.activeReport=$scope.customValues.trades[current+1].key})};$scope.activeReport=$scope.customValues.trades[0].key},template:'<div class="page-progress center">'+'<i ng-class="{\'current-circle\': getIndex(activeReport) === 0}" class="fa fa-circle"></i>'+'<i ng-class="{\'current-circle\': getIndex(activeReport) === 1}" class="fa fa-circle"></i>'+'<i ng-class="{\'current-circle\': getIndex(activeReport) === 2}" class="fa fa-circle"></i>'+
'<i ng-class="{\'current-circle\': getIndex(activeReport) === 3}" class="fa fa-circle"></i>'+"</div>"+'<div class="pure-g">'+'<div ng-repeat="trade in customValues.trades" class="pure-u-1 pure-u-md-1-4">'+'<div class="unit" ng-click="setActiveReport(trade.key)" ng-class="{hoverable: activeReport === trade.key}">'+'<a ng-click="$event.preventDefault(); prevReport();"><i class="unit__nav unit__nav--left fa fa-fw fa-chevron-left"></i></a>'+'<img ng-attr-src="{{trade.imageSrc}}" />'+'<div ng-bind="trade.name" class="title large lighter"></div>'+
'<div ng-bind="trade.balance | format:\'c2\'" class="value large bold"></div>'+'<a ng-click="$event.preventDefault(); nextReport();"><i class="unit__nav unit__nav--right fa fa-fw fa-chevron-right"></i></a>'+"</div>"+"</div>"+"</div>"}});
rh.ng.directive("creditScoreReportAccounts",function(){return{restrict:"A",controller:function($scope){$scope.$watch("report",function(newValue,oldValue){if(newValue!==oldValue)for(var i=0;i<$scope.customValues.trades.length;i++){var tradeKey=$scope.customValues.trades[i].key;$scope.customValues.trades[$scope.getIndex(tradeKey)].accounts=[];if(!$scope.report.trades[tradeKey])continue;for(var j=0;j<$scope.report.trades[tradeKey].length;j++){var tradeAccount=$scope.report.trades[tradeKey][j];var account=
{name:tradeAccount.CreditorId.Name||"UNKNOWN",balance:$scope.removeLeadingZeroes(tradeAccount.BalanceAmount),fields:$scope.unpack(tradeAccount,$scope.customValues.accountFields)};$scope.customValues.trades[$scope.getIndex(tradeKey)].accounts.push(account)}}},true);$scope.setActiveAccount=function(index){$scope.activeAccount=index}},template:'<table ng-repeat="trade in customValues.trades" ng-if="report.trades[trade.key].length" ng-show="activeReport === trade.key" class="touchable">'+"<thead>"+"<tr>"+
"<th>Account</th>"+"<th>Balance</th>"+"</tr>"+"</thead>"+"<tbody>"+'<tr ng-repeat="account in customValues.trades[getIndex(trade.key)].accounts | orderBy:\'name\'" ng-click="activeAccount === $index ? setActiveAccount(null) : setActiveAccount($index)" ng-class="{\'rh-credit-score__report__accounts--open\': activeAccount === $index}">'+"<td>"+'<span ng-bind="account.name"></span>'+'<div ng-show="activeAccount === $index" class="account-details pure-g">'+'<div class="pure-u-1 pure-u-md-1-2">'+'<div ng-repeat="field in account.fields" ng-if="$even" class="account-field">'+
'<label ng-bind="field.name" class="pure-u-2-5"></label>'+'<span ng-bind-html="field.value" class="pure-u-3-5"></span>'+"</div>"+"</div>"+'<div class="pure-u-1 pure-u-md-1-2">'+'<div ng-repeat="field in account.fields" ng-if="$odd" class="account-field">'+'<label ng-bind="field.name" class="pure-u-2-5"></label>'+'<span ng-bind-html="field.value" class="pure-u-3-5"></span>'+"</div>"+"</div>"+"</div>"+"</td>"+"<td>"+"<span ng-bind=\"account.balance | format:'c2'\"></span>&nbsp"+"<i ng-class=\"{'fa-chevron-down': activeAccount === $index, 'fa-chevron-right': activeAccount !== $index}\" class=\"fa fa-fw smallest\"></i>"+
"</td>"+"</tr>"+"</tbody>"+"</table>"}});
rh.ng.directive("creditScoreReportCollections",function($filter){return{restrict:"A",controller:function($scope){$scope.$watch("report",function(newValue,oldValue){if(newValue!==oldValue){$scope.report.collections=$scope.report.collections||[];$scope.customValues.collections=[];$scope.customValues.summary[$scope.getIndex("collections")].value=$scope.report.collections.length;for(var i=0;i<$scope.report.collections.length;i++){var collectionAccount=$scope.report.collections[i];var account={name:checkNested(collectionAccount,
"CollectionCreditor")?collectionAccount.CollectionCreditor.AccountNumberAndOrName:"UNKNOWN",paid:checkNested(collectionAccount,"DatePaid")?"Paid":"Unpaid",fields:$scope.unpack(collectionAccount,$scope.customValues.collectionFields)};$scope.customValues.collections.push(account)}}},true);$scope.setActiveCollection=function(index){$scope.activeCollection=index}},template:'<p ng-show="customValues.collections.length === 0" class="rh-credit-score__report__other--clean">'+'<span class="bold">Clean slate!</span>&nbsp;'+
"As of your latest update, you have no collections on your credit report."+"</p>"+'<table ng-show="customValues.collections.length > 0" class="touchable">'+"<thead>"+"<tr>"+"<th>Creditor</th>"+"<th>Status</th>"+"</tr>"+"</thead>"+"<tbody>"+'<tr ng-repeat="collection in customValues.collections | orderBy:\'name\'" ng-click="activeCollection === $index ? setActiveCollection(null) : setActiveCollection($index)" ng-class="{\'rh-credit-score__report__accounts--open\': activeCollection === $index}">'+"<td>"+
'<span ng-bind="collection.name"></span>'+'<div ng-show="activeCollection === $index" class="account-details">'+'<div ng-repeat="field in collection.fields" class="account-field pure-g">'+'<label ng-bind="field.name" class="pure-u-2-5"></label>'+'<span ng-bind-html="field.value" class="pure-u-3-5"></span>'+"</div>"+"</div>"+"</td>"+"<td>"+'<span ng-bind="collection.paid"></span>&nbsp'+"<i ng-class=\"{'fa-chevron-down': activeCollection === $index, 'fa-chevron-right': activeCollection !== $index}\" class=\"fa fa-fw smallest\"></i>"+
"</td>"+"</tr>"+"</tbody>"+"</table>"}});
rh.ng.directive("creditScoreReportInquiries",function(){return{restrict:"A",controller:function($scope){$scope.$watch("report",function(newValue,oldValue){if(newValue!==oldValue){$scope.report.inquiries=$scope.report.inquiries||[];$scope.customValues.inquiries=[];for(var i=0;i<$scope.report.inquiries.length;i++){var inquiryAccount=$scope.report.inquiries[i];var inquiry={};var lender="UNKNOWN";if(checkNested(inquiryAccount,"CustomerId","Name"))lender=inquiryAccount.CustomerId.Name;inquiry.lender=lender;
inquiry.date=inquiryAccount.date;$scope.customValues.inquiries.push(inquiry)}}},true)},template:'<p ng-show="customValues.inquiries.length === 0" class="rh-credit-score__report__other--clean">'+'<span class="bold">No inquiries on file!</span>&nbsp;'+"As of your latest update, you have no credit inquiries on your credit report."+"</p>"+'<table ng-show="customValues.inquiries.length > 0">'+"<thead>"+"<tr>"+"<th>Lender</th>"+"<th>Date</th>"+"</tr>"+"</thead>"+"<tbody>"+"<tr ng-repeat=\"inquiry in customValues.inquiries | orderBy:'-date'\">"+
"<td>"+'<span ng-bind="inquiry.lender"></span>'+"</td>"+"<td>"+"<span ng-bind=\"inquiry.date | format:'d':'MMM d, yyyy'\" class=\"bold\"></span>"+"</td>"+"</tr>"+"</tbody>"+"</table>"}});
