$(function(){var map=null;var location=ratehub.user.location;var options={center:[location.latitude,location.longitude],callback:function(){map.addMarker(ratehub.offices,true)}};map=new rh.Map($(".location")[0],options)});rh.ng.controller("ContactUsCtrl",function($scope,rhHttpRequestService){$scope.inputs={city:ratehub.user.location};$scope.thankyou=$(".rh-thankyou").clone();$scope.setFormId=function(formId){$scope.formId=formId};$scope.isInvalid=function(elem){return elem.$invalid&&(elem.$dirty||$scope.form.submitted)};$scope.submitForm=function(){if($scope.form.$valid){var $form=$("#"+$scope.formId);var formData=$form.serialize();var $button=$form.find("button");$button.prop("disabled",true);var options={url:"/api/contact",
data:formData,headers:{"Content-Type":"application/x-www-form-urlencoded"},success:function(data){$form.html($scope.thankyou)},error:function(data){alert("There was an error submitting your information. Please contact us directly by calling 1-800-679-9622 or using the 'contact us' link at the top right of the page.");$button.prop("disabled",false)}};rhHttpRequestService.post(options)}else $scope.form.submitted=true}});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);rh.ng.directive("rateDetails",function(rhEnvironmentService){return{restrict:"C",controller:"RateDetailsCtrl",link:function(scope,elem,attrs){scope.productType=attrs.productType;scope.productId=attrs.productId;scope.showCustomAlert=false;if(rhEnvironmentService.isMobileView())scope.doMobile()}}});
rh.ng.controller("RateDetailsCtrl",function($scope,$timeout,$compile,rhConversionService,eyeReturnService,depositsService){$scope.inputs={bttc:"anytime",city:ratehub.user.location,investmentAmount:1E4};$(".non-monetized .compare a").click(function(){event.preventDefault();event.stopPropagation();window.top.location=$(this).attr("href")});$scope.isInvalid=function(elem){return elem.$invalid&&(elem.$dirty||$scope.detailsForm.submitted)};$scope.submitForm=function(){if($scope.detailsForm.$valid){$("#detailsForm button[type=submit]").attr("disabled",
true);var formData=$("#detailsForm").serialize();formData+="&province="+$scope.inputs.city.province.code;var params=parseUrlParams();if(!params.additionalFundsNeeded&&params.additionalEquity)formData+="&additionalFundsNeeded="+params.additionalEquity;if(!params.currentMortgageBalance&&params.mortgageBalance)formData+="&currentMortgageBalance="+params.mortgageBalance;if(!params.homePrice&&params.helocLimit)formData+="&homePrice="+params.helocLimit;if(params.downPayment)formData+="&downPayment="+params.downPayment;
if(params.approximateMortgageAmount)formData+="&approximateMortgageAmount="+params.approximateMortgageAmount;if(params.totalMortgageNeeded)formData+="&totalMortgageNeeded="+params.totalMortgageNeeded;var options={serializedForm:formData,vertical:"mtg",type:$scope.isAgentView()?"agent":$scope.productType,isPaid:true,product:{providerName:$scope.inputs.providerName,productDescription:$scope.inputs.productDescription},done:function(data){if(!$scope.isAgentView())data.isQuoted=$scope.inputs.isQuoted;
if($scope.productType==="mortgage"&&$scope.inputs.featured&&!ratehub.isWidget)eyeReturnService.getEyeReturnTagCode("submit_request_button",{"subscribe":$scope.inputs.subscribe,"productType":$scope.productType,"data":data,"mortgage":true});else eyeReturnService.getThankYouPopup($scope.inputs.subscribe,$scope.productType,data)}};if($scope.productType==="creditcard"){options.card=ratehub.creditCard;window.open(options.card.apply_redirect,"_blank");if(!options.subscribe)options.hitCallback=eyeReturnService.redirect}rhConversionService.lead(options)}else $scope.detailsForm.submitted=
true};$scope.preApprovalClick=function(hasPreApprovalApp,hasCpcLink,isQuoted,providerId){var type="";if(hasPreApprovalApp)type="CPA_CLICK";else if(hasCpcLink)type="CPC_CLICK";var options={monetizationType:type,isPaid:hasPreApprovalApp||hasCpcLink,type:"mortgage",is_quoted:isQuoted,product:{id:$scope.inputs.moreRatesProductId?$scope.inputs.moreRatesProductId:$scope.productId,providerId:providerId,providerName:$scope.inputs.moreRatesProviderName?$scope.inputs.moreRatesProviderName:$scope.inputs.providerName,
productDescription:$scope.inputs.moreRatesProductDescription?$scope.inputs.moreRatesProductDescription:$scope.inputs.productDescription}};rhConversionService.trackWebClick(options);rhConversionService.preApprovalClick(options);eyeReturnService.getThankYouPopup(false,"mortgage",{})};$scope.phoneClick=function(event){var clickedButton=$(event.target);if($scope.isMobile){clickedButton.off("click");event.preventDefault()}var options={isPaid:!clickedButton.hasClass("unpaid"),type:$scope.productType,vertical:"mtg",
product:{id:$scope.productId,providerName:$scope.inputs.providerName,productDescription:$scope.inputs.productDescription}};if($scope.isAgentView())options.isAgent=true;if($scope.isQuotedRate())options.isQuoted=true;$scope.phoneNumber=ratehub.providerPhone;if($scope.isMobile)clickedButton.attr("href","tel:"+$scope.phoneNumber).removeClass("rh-button").text($scope.phoneNumber);rhConversionService.phoneClick(options)};$scope.webClick=function(event){event.preventDefault();var clickedButton=$(event.target);
var monetized=!clickedButton.hasClass("unpaid");var productHref=clickedButton.attr("productHref");var options={isPaid:monetized,type:$scope.productType,vertical:"mtg",product:{id:$scope.productId,providerName:$scope.inputs.providerName,productDescription:$scope.inputs.productDescription}};if($scope.isAgentView())options.isAgent=true;if($scope.isQuotedRate())options.isQuoted=true;window.open(rhConversionService.getCloakedUrl(productHref),"_blank");rhConversionService.webClick(options);eyeReturnService.getThankYouPopup(false,
$scope.productType,{isQuoted:$scope.isQuotedRate()})};$scope.depositsWebClick=function(event,vertical){event.preventDefault();var clickedButton=$(event.target);var monetized=!clickedButton.hasClass("unpaid");var href=clickedButton.attr("href");var verticalSlug="GIC";if(vertical==="savings")verticalSlug="SAV";if(typeof heapEvent==="function")heapEvent(verticalSlug+" Web Click",{"href":href,"provider":$scope.inputs.providerName,"monetized":monetized?"true":"false"});var options={isPaid:monetized,type:$scope.productType,
vertical:vertical,product:{id:$scope.productId,providerName:$scope.inputs.providerName,productDescription:$scope.inputs.productDescription}};var url=depositsService.getApplyRedirect(href);window.open(url,"_blank");eyeReturnService.getThankYouPopup(false,$scope.productType,{});rhConversionService.trackConversion(options,"web")};$scope.isAgentView=function(){return $scope.inputs.agent};$scope.isQuotedRate=function(){return $scope.inputs.quotedRate};$scope.doMobile=function(){$scope.isMobile=true;if($(".rate-details .connect-call").length>
0){var oldPhoneButton=$(".rate-details .connect-call .rh-button");var phoneButton=$('<a class="rh-button"></a>');phoneButton.text(oldPhoneButton.text());oldPhoneButton.remove();$('<div class="mobile-phone-button"></div>').append(phoneButton).appendTo(".rate-details .info");phoneButton.on("click",function(){$scope.phoneClick(event)});$(".rate-details .connect-call").remove()}if($scope.productType==="mortgage"||$scope.productType==="gic"||$scope.productType==="savings"){var rateInfo=$(".detailed-info > table");
if(rateInfo.length>0){var container=$('<div class="mobile-detailed-info"></div>');var banner=$('<div class="rh-banner-alt"></div>');banner.append('<div class="rh-banner-left"></div>');var titleString=$scope.productType==="mortgage"?"rate-details-title":"show-more-details-title";banner.append("<span ng-bind=\"'"+titleString+"' | localize\"></span>");banner.append('<div class="rh-banner-right"></div>');$timeout(function(){banner=$compile(banner)($scope);container.insertAfter(".rate-details");banner.appendTo(container);
rateInfo.addClass("detailed-info").appendTo(container);rateInfo.addClass("detailed-info--"+$scope.productType).appendTo(container)})}}};$scope.autoFillLeadForm=function(){var r=function(length){return Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,length)};var p=function(){var p="";for(var i=0;i<7;i++)p+=""+Math.floor(Math.random()*9+1);return p};$("input#name").val(r(5)+r(5));$("input#phone").val("613"+p());$("input#email").val(r(5)+"@"+r(5)+"."+r(2));$("select#mortgage_type").val("Purchase");
$("select#amount").val("$100,000 - $150,000");setTimeout(function(){$("input#name").blur();$("input#phone").blur();$("input#email").blur();$("select#amount").blur();$("select#mortgage_type").trigger("change");$("select#amount").trigger("change")},0)};$scope.showTiers=function($event){var $target=$($event.target);$target.siblings(".rh-tooltip-container").find(".rh-tooltip").mouseover()};$scope.hideTiers=function($event){var $target=$($event.target);$target.siblings(".rh-tooltip-container").find(".rh-tooltip").mouseout()};
$scope.refreshRate=function(){if($scope.inputs.mortgage_type==="Not sure")return;var params=parseUrlParams();switch($scope.inputs.mortgage_type){case "Pre-approval":params.scenario="pre_approval";break;case "Renewal":params.scenario="renew";break;default:params.scenario=$scope.inputs.mortgage_type.toLowerCase()}if(ratehub.rateVariants[params.scenario]){if(params.scenario==="pre_approval"){params.scenario="purchase";params.pre_approval=true}else params.pre_approval=false;if(!$scope.isQuotedRate())params.posted=
ratehub.rateVariants[params.scenario].posted;else params.posted=false;var url=appendQueryParams(window.location.href,params);var xhr=$.ajax(url);var rateCell=$(".info td.rate");var rateDisplay=rateCell.find(".rh-rate");rateDisplay.hide();if(!rateCell.find("#rate_refresh_image").length)rateCell.prepend('<span id="rate_refresh"></span>');var refreshDisplay=rateCell.find("#rate_refresh");refreshDisplay.css({"display":"block","min-height":rateDisplay.height()+"px","background-image":"url(/assets/images/LoadingDots.gif)",
"background-position":"0% center","background-repeat":"no-repeat"}).show();$("#detailsForm button[type=submit]").attr("disabled",true);xhr.success(function(html,textStatus,jqXHR){if(html){var newHtml=$('<div id="body-mock">'+html.replace(/^[\s\S]*<body.*?>|<\/body>[\s\S]*$/ig,"")+"</div>");$(".info").html(newHtml.find(".info"));var inputNames=["rate_id","quoted_rate_id","external_id","scenario"];$.each(inputNames,function(i,name){$("input[name="+name+"]").val(newHtml.find("input[name="+name+"]").val())});
$("#detailsForm button[type=submit]").attr("disabled",false)}})}else{$scope.redirectHref=ratehub.rateVariants["redirectUrls"][params.scenario];$scope.showCustomAlert=true}};$(window).load(function(event){if($scope.productType==="mortgage"&&$scope.inputs.featured)eyeReturnService.getEyeReturnTagCode("get_rate_popup",{"rateIDs":$scope.inputs.externalID,"mortgage":true})})});rh=window.rh||{};rh.ng=rh.ng||angular.module("ratehub",[]);
rh.ng.directive("rhThankyou",function(rhEnvironmentService){return{restrict:"C",controller:"ThankyouCtrl",link:function(scope,elem,attrs){if(rhEnvironmentService.isMobileView($(window.top))){scope.frameWidth="100%";scope.frameHeight=550}else{scope.frameWidth=800;scope.frameHeight=600}scope.resizeFrame();scope.conversionId=attrs.conversion?attrs.conversion:null;if(ratehub.mortgageDetails){var mortgageDetails=JSON.parse(ratehub.mortgageDetails);var ourHeap=typeof heap!=="undefined"?heap:window.parent.heap;
ourHeap.track("Mortgage conversion",mortgageDetails);delete ratehub.mortgageDetails}scope.findApplicationUri=attrs.findApplicationUri?attrs.findApplicationUri:null}}});
rh.ng.controller("ThankyouCtrl",function($scope,$interval){$scope.applicationUrlPromise=false;$scope.applicationUrl=false;$scope.getApplicationUrl=function(findApplicationUri){if($scope.applicationUrlPromise)return false;else if($scope.applicationUrl){var ourHeap=typeof heap!=="undefined"?heap:window.parent.heap;ourHeap.addUserProperties({leadToAppUrl:$scope.applicationUrl});return $scope.applicationUrl}else{$scope.applicationUrlPromise=$interval(queryApplicationUrlApi,200,25);return false}};function queryApplicationUrlApi(){$.ajax({type:"GET",
url:$scope.findApplicationUri+$scope.conversionId,success:function(result){result=JSON.parse(result);if($scope.applicationUrlPromise){$interval.cancel($scope.applicationUrlPromise);$scope.applicationUrlPromise=false}var ourHeap=typeof heap!=="undefined"?heap:window.parent.heap;ourHeap.addUserProperties({sawLeadToAppButton:true});$scope.applicationUrl=result.data.application_url}})}$scope.submitForm=function(){};$scope.resizeFrame=function(){if(window.parent.jQuery&&window.parent.jQuery.colorbox)window.parent.jQuery.colorbox.resize({innerWidth:$scope.frameWidth,
innerHeight:$scope.frameHeight});else jQuery(function(){var frame=jQuery(window);var container=jQuery("#container");container.css("margin-top",(frame.height()-$scope.frameHeight)/2)})}});$(function(){function loadWidget(name,params){if(!params)params={};if(params.license){var license=params.license;delete params.license}params.snippet="snippet";params.lang=Globalize.culture().language;var widgetPreview=$("#preview-"+name);$.ajax({url:"/widgets/"+name+".php",data:params,type:"GET",success:function(result){result=result.replace(/[\t\r\n]*/g,"");widgetPreview.prev("table").find(".widget-snippet").text(!license?result:Globalize.localize("widget-license-required"));var iframe=document.createElement("iframe");
iframe.width="100%";iframe.frameBorder="0";iframe.onload=function(){var document=iframe.contentWindow.document;var loading=document.createElement("img");loading.src="/assets/images/loading_blue.gif";var widgetRoot=document.getElementsByClassName("widget")[0];if(widgetRoot)widgetRoot.appendChild(loading)};widgetPreview.html(iframe);poll(500,1E3,function(){var widgetRoot=iframe.contentWindow.document.body.firstChild;if(widgetRoot)iframe.height=Math.max(widgetRoot.offsetHeight,800);return false});var html=
'<!DOCTYPE html><html><body style="margin:0;overflow-x:hidden">'+result+"</body></html>";iframe.contentWindow.document.open();iframe.contentWindow.document.write(html);iframe.contentWindow.document.close()}})}function getWidgetParams(scope){var params=null;scope.find("select, input").each(function(index,element){element=$(element);if(element.val()!=""){if(!params)params={};params[element.attr("name")]=element.val()}});if(params&&params.rateinput&&params.rateinput=="text-only")params.license=true;
return params}$(".widget-preview").each(function(i,element){var preview=$(element);var table=preview.prev("table");table.find("select").change(function(event){preview.empty();loadWidget(preview.attr("id").substring(8),getWidgetParams(table))});loadWidget(preview.attr("id").substring(8),getWidgetParams(table))})});
